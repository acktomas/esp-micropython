# ESP32直流减速电机PID控制系统

这是一个基于ESP32的直流减速电机精确角度控制系统，使用霍尔传感器反馈和PID算法实现快速、精准的角度控制。非常适合学习PID控制原理和实践。

## 📚 项目特色

- **完整的PID学习项目** - 从理论到实践的完整学习路径
- **模块化设计** - 清晰的代码结构，易于理解和修改
- **丰富的调试工具** - 包含各种测试和调参程序
- **详细的学习指导** - 每个模块都有详细注释和说明

## 🎯 学习目标

通过这个项目，你将学会：

1. **电机驱动控制** - PWM调速、方向控制
2. **编码器原理** - 霍尔传感器信号处理、角度计算
3. **PID控制算法** - P、I、D三个参数的作用和调节
4. **系统集成** - 将多个模块整合成完整系统
5. **参数调优** - 实际的PID参数调节技巧

## 🔧 硬件要求

### 必需硬件
- ESP32开发板 (推荐ESP32-WROOM-32)
- 直流减速电机 (带霍尔传感器)
- L298N电机驱动模块
- 面包板和杜邦线

### 接线说明

#### 电机驱动器连接
```
ESP32     →   L298N
GPIO25    →   ENA  (PWM使能)
GPIO26    →   IN1  (方向控制1)
GPIO27    →   IN2  (方向控制2)
5V        →   +5V  (逻辑电源)
GND       →   GND  (地线)
```

#### 霍尔传感器连接
```
霍尔传感器   →   ESP32
A相信号     →   GPIO4
B相信号     →   GPIO5
VCC         →   3.3V 或 5V (根据传感器规格)
GND         →   GND
```

#### 电源连接 (12V电机)
```
12V电源      → L298N VS供电
L298N输出    → 电机正负极
ESP32电源    → USB供电或12V转5V
```

## 📁 项目结构

```
gear-motor-has-hall-sentor/
├── motor_driver.py      # 电机驱动模块
├── encoder_reader.py    # 编码器读取模块  
├── pid_controller.py    # PID控制器模块
├── main_control.py      # 主控制程序
├── test_tools.py        # 测试和调参工具
├── blink.py             # 基础LED测试
└── README.md            # 项目说明文档
```

## 🚀 快速开始

### 1. 硬件连接
按照上述接线说明连接所有硬件。

### 2. 基础测试
首先测试基础功能：

```python
# 测试LED (确认ESP32工作正常)
exec(open('blink.py').read())

# 测试电机
exec(open('motor_driver.py').read())

# 测试编码器  
exec(open('encoder_reader.py').read())
```

### 3. 运行主程序
```python
exec(open('main_control.py').read())
```

### 4. 学习和调参
```python
exec(open('test_tools.py').read())
```

## 📖 模块详解

### 1. motor_driver.py - 电机驱动模块
- 支持PWM调速 (-100% 到 +100%)
- 正反转控制
- 刹车和惰性停止功能
- 内置测试程序

**主要类**：`MotorDriver`

**关键方法**：
- `set_speed(speed)` - 设置速度 (-100 到 100)
- `forward(speed)` - 正转
- `backward(speed)` - 反转  
- `stop()` - 刹车停止

### 2. encoder_reader.py - 编码器读取模块
- 支持霍尔传感器信号处理
- 四倍频解码技术
- 角度、速度计算
- 中断驱动的实时响应

**主要类**：`EncoderReader`

**关键方法**：
- `get_angle()` - 获取当前角度
- `get_speed_rpm()` - 获取转速
- `reset()` - 重置计数器

### 3. pid_controller.py - PID控制模块
- 完整的PID算法实现
- 抗积分饱和处理
- 微分项滤波
- 自动调参功能

**主要类**：`PIDController`, `PIDTuner`

**关键参数**：
- `Kp` - 比例增益
- `Ki` - 积分增益
- `Kd` - 微分增益

### 4. main_control.py - 主控制程序
- 整合所有模块
- 角度控制主循环
- 自动控制演示
- 位置信息监控

**主要类**：`MotorAngleController`

### 5. test_tools.py - 测试调参工具
- 系统功能测试
- PID参数学习
- 交互式调参
- 性能分析

## 🎓 PID学习指南

### 第1步：理解基础概念
运行测试工具学习PID各参数的作用：

```python
exec(open('test_tools.py').read())
```

### 第2步：单独测试每个参数
- **P控制器演示** - 观察比例项的影响
- **I控制器演示** - 理解积分项消除稳态误差
- **D控制器演示** - 学习微分项的阻尼作用

### 第3步：参数调节步骤

#### 经典调参方法 (Ziegler-Nichols) - 适配你的电机

1. **调P参数**
   - 设置 Ki=0, Kd=0, 从Kp=0.5开始
   - 逐步增加到Kp=3-5，观察系统响应
   - 对于12V减速电机，Ku通常在2-4之间
   - Tu(振荡周期)约为0.5-1.5秒

2. **计算参数**
   ```
   Kp = 0.6 * Ku
   Ki = 2 * Kp / Tu  
   Kd = Kp * Tu / 8
   ```

3. **针对你的电机的推荐初始值**
   ```
   基础控制: Kp=1.5, Ki=0.2, Kd=0.08
   快速响应: Kp=2.5, Ki=0.4, Kd=0.12
   精确定位: Kp=2.0, Ki=0.6, Kd=0.15
   ```

4. **微调**
   - 如果超调太大(>20%) → 减小Kp，增加Kd
   - 如果响应太慢(上升时间>2s) → 增加Kp
   - 如果有稳态误差(>3°) → 增加Ki
   - 如果振荡不停 → 减小Kp，增加Kd

#### 经验值参考 (针对你的12V减速电机)
```
初始参数: Kp=1.0, Ki=0.1, Kd=0.05
轻载运行: Kp=2-5, Ki=0.2-0.8, Kd=0.05-0.15  
重载运行: Kp=3-8, Ki=0.3-1.5, Kd=0.1-0.3
```

### 第4步：性能评估
好的PID系统应该具备：
- **快速响应** - 上升时间短
- **小超调** - 超调量 < 20%
- **无稳态误差** - 稳态误差 < 2%
- **无振荡** - 稳定到达目标值

## 🔧 配置说明

### 硬件配置参数
在代码中找到以下配置，根据实际情况修改：

```python
# 电机驱动配置
motor_config = {
    'pwm_pin': 25,    # PWM引脚
    'in1_pin': 26,    # 方向控制1  
    'in2_pin': 27,    # 方向控制2
    'freq': 1000      # PWM频率
}

# 编码器配置 (适配你的电机规格)
encoder_config = {
    'hall_a_pin': 4,      # 霍尔A相
    'hall_b_pin': 5,      # 霍尔B相
    'ppr': 11,            # 每转脉冲数 (11个霍尔脉冲)
    'gear_ratio': 30      # 减速比 (30:1)
}
```

### PID参数配置
```python
pid_config = {
    'kp': 2.0,            # 比例增益
    'ki': 0.5,            # 积分增益
    'kd': 0.1,            # 微分增益
    'output_min': -80.0,  # 输出限制
    'output_max': 80.0,   # 输出限制
    'sample_time': 0.01   # 采样时间
}
```

## 🐛 常见问题

### 1. 电机不转动
- 检查电源连接和电压
- 确认L298N使能引脚连接正确
- 检查电机驱动代码中的引脚配置

### 2. 编码器读数异常
- 检查霍尔传感器供电
- 确认A、B相信号接线
- 检查ppr和gear_ratio参数是否正确

### 3. PID控制效果差
- 逐步调节参数，不要一次性改变太大
- 确认编码器反馈准确
- 检查目标设置是否合理

### 4. 系统振荡
- 减小Kp值
- 增加Kd值提供阻尼
- 检查机械系统是否松动

## 📈 进阶实验

### 1. 轨迹跟踪
实现连续角度轨迹跟踪，如正弦波、方波等。

### 2. 速度控制
基于编码器反馈实现精确的速度控制。

### 3. 多电机同步
控制多个电机实现同步运动。

### 4. 自适应PID
实现参数自动调节的自适应PID控制。

## 📚 参考资料

- [PID控制原理详解](https://zh.wikipedia.org/wiki/PID控制器)
- [MicroPython官方文档](https://docs.micropython.org/)
- [ESP32技术参考手册](https://www.espressif.com/sites/default/files/documentation/esp32_datasheet_en.pdf)

## 🤝 贡献

欢迎提交问题和改进建议！

## 📄 许可证

MIT License - 可自由使用和修改

---

**祝学习愉快！通过这个项目，你将深入理解PID控制的精髓。** 🎓